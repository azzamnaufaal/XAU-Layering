<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XAU Layering - Hasil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .fade-in { animation: fade .35s ease both; }
    @keyframes fade { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform:none} }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 p-6 max-w-6xl mx-auto space-y-6">

  <!-- Header -->
  <div class="flex items-center justify-between fade-in">
    <div class="font-semibold text-xl">Hasil Simulasi</div>
    <div class="flex items-center gap-3">
      <div id="recap" class="hidden md:block text-xs text-gray-600"></div>
      <a href="form.html" class="px-4 py-2 rounded-xl border shadow-sm hover:bg-gray-50">Edit Inputs</a>
    </div>
  </div>

  <!-- Buckets (spacing editor) -->
  <div class="bg-white rounded-2xl shadow p-5 fade-in">
    <h3 class="font-semibold mb-2">Buckets</h3>
    <p class="text-xs text-gray-500 mb-3">
      Trigger otomatis: <b>B1 &lt; ⅓ modal</b>, <b>B2 ⅓–⅔ modal</b>, <b>B3 ≥ ⅔ modal</b>.
      Spacing bisa diubah, lalu tekan <b>Update Simulation</b>.
    </p>
    <div id="buckets" class="grid md:grid-cols-3 gap-4"></div>
    <div class="mt-3 flex flex-wrap items-center gap-3">
      <button id="btn-apply" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Update Simulation</button>
      <button id="btn-reset" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Reset Spacing (B2=$5, B3=$10)</button>
    </div>
  </div>

  <!-- Summary -->
  <div class="bg-white rounded-2xl shadow p-5 fade-in">
    <h3 class="font-semibold mb-2">Summary</h3>
    <div id="summary">–</div>
  </div>

  <!-- Tabel -->
  <div class="bg-white rounded-2xl shadow p-5 fade-in">
    <h3 class="font-semibold mb-2">Tabel Layer</h3>
    <div class="overflow-auto rounded-xl border">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="text-left p-2">Layer</th>
            <th class="text-left p-2">Bucket</th>
            <th class="text-left p-2">Harga</th>
            <th class="text-left p-2">Floating Loss</th>
            <th class="text-left p-2">Equity</th>
            <th class="text-left p-2">Status</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Grafik -->
  <div class="bg-white rounded-2xl shadow p-5 fade-in">
    <h3 class="font-semibold mb-2">Grafik Equity</h3>
    <canvas id="chart" height="160"></canvas>
  </div>

  <script>
    // ===== Params & State =====
    const params = new URLSearchParams(window.location.search);
    const inputs = {
      modal: +params.get("modal"),
      lot:   +params.get("lot"),
      price: +params.get("price"),
    };
    const s1Initial = +(params.get("s1") || 2); // spacing awal untuk B1 (dari form)
    const CONTRACT_SIZE = 100;

    // Buckets: trigger fix by modal; spacing: B1 from form, B2=5, B3=10 (editable)
    let buckets = [
      { name:"B1", trigger: inputs.modal/3,     spacing: s1Initial, note:"< ⅓ modal" },
      { name:"B2", trigger: 2*inputs.modal/3,   spacing: 5,         note:"⅓–⅔ modal" },
      { name:"B3", trigger: Infinity,           spacing: 10,        note:"≥ ⅔ modal" },
    ];

    let chartRef = null;

    // ===== Helpers =====
    const $  = id => document.getElementById(id);
    const fmt  = n => Number(n ?? 0).toLocaleString("en-US");
    const fmt2 = n => (isFinite(n) ? Number(n).toFixed(2) : "0.00");
    const pct  = x => `${isFinite(x) ? x.toFixed(2) : "0.00"}%`;

    // ===== Buckets editor (spacing only) =====
    function renderBucketsEditor(){
      const wrap = $("buckets"); wrap.innerHTML = "";
      buckets.forEach((b,i)=>{
        const card = document.createElement("div");
        card.className = "rounded-xl border p-4 space-y-2";
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-medium">${b.name}</div>
            <span class="text-xs text-gray-500">${b.note}</span>
          </div>
          <div class="text-xs text-gray-500">Trigger (USC): <b>${b.trigger === Infinity ? "—" : fmt(b.trigger)}</b></div>
          <label class="block text-sm">
            <span class="text-gray-600">Spacing ($/layer)</span>
            <input data-idx="${i}" type="number" step="0.1" value="${b.spacing}"
                   class="mt-1 w-full border rounded-lg p-2"/>
          </label>
        `;
        wrap.appendChild(card);
      });
    }
    function readSpacings(){
      document.querySelectorAll('#buckets input[type="number"]').forEach(inp=>{
        const idx = +inp.dataset.idx;
        const val = +inp.value;
        if(!isNaN(val) && val>0) buckets[idx].spacing = val;
      });
    }
    function resetSpacings(){
      buckets[1].spacing = 5;  // B2 default
      buckets[2].spacing = 10; // B3 default
      renderBucketsEditor();
    }

    // ===== Simulation =====
    function simulate(){
      const valPerDollar = inputs.lot * CONTRACT_SIZE;
      // sort by trigger (Infinity at end handled by value)
      const bs = [...buckets].sort((a,b)=> (a.trigger>b.trigger?1:-1) );

      let rows=[], offset=0, floating=0, stop=null;
      for(let i=1;i<=200;i++){
        // pilih bucket berdasarkan floating loss kumulatif
        const b = bs.find(x => floating < x.trigger) || bs.at(-1);
        offset += b.spacing;
        const harga = inputs.price - offset;
        const fl    = (inputs.price - harga) * valPerDollar;
        floating += fl;
        const equity = inputs.modal - floating;
        const status = equity <= 0 ? "STOP" : "";
        rows.push({ layer:i, bucket:b.name, harga, floating, equity, status });
        if(status==="STOP"){ stop = rows.at(-1); break; }
      }
      return { rows, stop };
    }

    // ===== Render all =====
    function renderAll(){
      // recap
      $("recap").innerHTML = `
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 text-gray-700">
          Modal: <b>${fmt(inputs.modal)} USC</b> • Lot/layer: <b>${inputs.lot}</b> • Harga awal: <b>${inputs.price}</b>
        </span>`;

      const { rows, stop } = simulate();

      // summary
      const last = rows.at(-1);
      const minEq = Math.min(...rows.map(r=>r.equity));
      const minPrice = Math.min(...rows.map(r=>r.harga));
      const maxDD = ((inputs.modal - minEq) / inputs.modal) * 100;
      const statusBadge = stop
        ? `<span class="px-2 py-1 rounded bg-red-50 text-red-700 text-xs font-semibold">STOP</span>`
        : `<span class="px-2 py-1 rounded bg-emerald-50 text-emerald-700 text-xs font-semibold">BERJALAN</span>`;

      $("summary").innerHTML = `
        <div class="flex items-center gap-3 mb-3">${statusBadge}
          <span class="text-xs text-gray-500">Max Drawdown: <b>${pct(maxDD)}</b></span>
        </div>
        <div class="grid md:grid-cols-3 gap-3">
          <div class="rounded-xl border p-4">
            <div class="text-gray-500 text-xs mb-1">Layer</div>
            <div class="text-lg font-semibold">${stop ? stop.layer : last.layer}</div>
            <div class="text-xs text-gray-500">${stop ? "Layer STOP" : "Layer terakhir"}</div>
          </div>
          <div class="rounded-xl border p-4">
            <div class="text-gray-500 text-xs mb-1">Harga ${stop ? "STOP" : "Terakhir"}</div>
            <div class="text-lg font-semibold">${fmt2(stop ? stop.harga : last.harga)}</div>
            <div class="text-xs text-gray-500">USD</div>
          </div>
          <div class="rounded-xl border p-4">
            <div class="text-gray-500 text-xs mb-1">Total Lot</div>
            <div class="text-lg font-semibold">${fmt2((stop ? stop.layer : last.layer) * inputs.lot)}</div>
            <div class="text-xs text-gray-500">lot</div>
          </div>
          <div class="rounded-xl border p-4">
            <div class="text-gray-500 text-xs mb-1">Floating Loss</div>
            <div class="text-lg font-semibold">${fmt(stop ? stop.floating : last.floating)}</div>
            <div class="text-xs text-gray-500">USC</div>
          </div>
          <div class="rounded-xl border p-4">
            <div class="text-gray-500 text-xs mb-1">Equity</div>
            <div class="text-lg font-semibold">${fmt(stop ? minEq : last.equity)}</div>
            <div class="text-xs text-gray-500">USC</div>
          </div>
          <div class="rounded-xl border p-4">
            <div class="text-gray-500 text-xs mb-1">Harga Terendah</div>
            <div class="text-lg font-semibold">${fmt2(minPrice)}</div>
            <div class="text-xs text-gray-500">USD</div>
          </div>
        </div>
      `;

      // table
      const tb = $("tbody"); tb.innerHTML = "";
      rows.forEach(r=>{
        tb.innerHTML += `
          <tr class="${r.status==='STOP'?'bg-red-50':''}">
            <td class="p-2">${r.layer}</td>
            <td class="p-2">${r.bucket}</td>
            <td class="p-2">${fmt2(r.harga)}</td>
            <td class="p-2">${fmt(r.floating)}</td>
            <td class="p-2">${fmt(r.equity)}</td>
            <td class="p-2">${r.status || ""}</td>
          </tr>`;
      });

      // chart
      const ctx = $("chart").getContext("2d");
      if(chartRef) chartRef.destroy();
      chartRef = new Chart(ctx, {
        type: "line",
        data: {
          labels: rows.map(r=>fmt2(r.harga)),
          datasets: [{ label:"Equity (USC)", data: rows.map(r=>r.equity), borderColor:"#2563eb", borderWidth:2, tension:.2 }]
        },
        options: { responsive:true, scales:{ x:{ title:{display:true,text:"Harga Entry"} }, y:{ title:{display:true,text:"Equity (USC)"} } } }
      });
    }

    // ===== Init & Events =====
    function attachEvents(){
      $("btn-apply").addEventListener("click", () => {
        readSpacings();
        renderAll();
      });
      $("btn-reset").addEventListener("click", () => {
        resetSpacings();
      });
    }

    (function init(){
      // recap strip (will be updated in renderAll)
      renderBucketsEditor();
      renderAll();
      attachEvents();
      // recap header
      $("recap").innerHTML = `
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 text-gray-700">
          Modal: <b>${fmt(inputs.modal)} USC</b> • Lot/layer: <b>${inputs.lot}</b> • Harga awal: <b>${inputs.price}</b>
        </span>`;
    })();
  </script>
</body>
</html>
