<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XAU Layering - Hasil</title>
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .fade-in { animation: fade .35s ease both; }
    @keyframes fade { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform:none} }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 p-6 max-w-6xl mx-auto space-y-6">

  <!-- Header -->
  <div class="flex items-center justify-between fade-in">
    <div class="font-semibold text-xl">Hasil Simulasi</div>
    <div class="flex items-center gap-3">
      <div id="recap" class="hidden md:block text-xs text-gray-600"></div>
      <a href="form.html" class="px-4 py-2 rounded-xl border shadow-sm hover:bg-gray-50">Edit Inputs</a>
    </div>
  </div>

  <!-- Buckets -->
  <div class="bg-white rounded-2xl shadow p-5 fade-in">
    <h3 class="font-semibold mb-2">Pembagian Modal</h3>
    <p class="text-xs text-gray-500 mb-4">
      Modal dibagi menjadi <b>3 Tahap</b>. Semakin dalam penurunan, gunakan spacing lebih renggang.<br>
      Tahap 2 dan 3 secara default menggunakan spacing 5 dan 10.
    </p>

    <div class="grid md:grid-cols-3 gap-4">
      <div class="rounded-2xl border p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Tahap 1 (Awal)</div>
          <span class="px-2 py-0.5 text-xs rounded bg-emerald-50 text-emerald-700">Rapat</span>
        </div>
        <label class="block text-sm">
          <span class="text-gray-700">Spacing ($/layer)</span>
          <input id="spacing-1" type="number" step="0.1" class="mt-1 w-full border rounded-lg p-2" placeholder="2">
        </label>
      </div>
      <div class="rounded-2xl border p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Tahap 2 (Menengah)</div>
          <span class="px-2 py-0.5 text-xs rounded bg-amber-50 text-amber-700">Sedang</span>
        </div>
        <label class="block text-sm">
          <span class="text-gray-700">Spacing ($/layer)</span>
          <input id="spacing-2" type="number" step="0.1" class="mt-1 w-full border rounded-lg p-2" placeholder="5" value="5">
        </label>
      </div>
      <div class="rounded-2xl border p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Tahap 3 (Darurat)</div>
          <span class="px-2 py-0.5 text-xs rounded bg-rose-50 text-rose-700">Lebar</span>
        </div>
        <label class="block text-sm">
          <span class="text-gray-700">Spacing ($/layer)</span>
          <input id="spacing-3" type="number" step="0.1" class="mt-1 w-full border rounded-lg p-2" placeholder="10" value="10">
        </label>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap items-center gap-3">
      <button id="btn-apply-spacing" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
        Update
      </button>
      <button id="btn-reset-spacing" class="px-4 py-2 rounded-lg border hover:bg-gray-50">
        Reset
      </button>
    </div>
  </div>

  <!-- Summary -->
  <div class="bg-white rounded-2xl shadow p-5 fade-in">
    <h3 class="font-semibold mb-2">Summary</h3>

    <!-- Kotak Kapasitas (dihitung dari tabel status) -->
    <div class="grid md:grid-cols-3 gap-3 mb-4">
      <div class="rounded-xl border p-4 bg-emerald-50">
        <div class="text-gray-500 text-xs mb-1">Tahap 1 (Awal)</div>
        <div class="text-lg font-semibold text-emerald-700" id="cap-1">–</div>
      </div>
      <div class="rounded-xl border p-4 bg-amber-50">
        <div class="text-gray-500 text-xs mb-1">Tahap 2 (Menengah)</div>
        <div class="text-lg font-semibold text-amber-700" id="cap-2">–</div>
      </div>
      <div class="rounded-xl border p-4 bg-rose-50">
        <div class="text-gray-500 text-xs mb-1">Tahap 3 (Darurat)</div>
        <div class="text-lg font-semibold text-rose-700" id="cap-3">–</div>
      </div>
    </div>

    <!-- Detail Summary -->
    <div id="summary-detail">–</div>
  </div>

  <!-- Tabel -->
  <div class="bg-white rounded-2xl shadow p-5 fade-in">
    <h3 class="font-semibold mb-2">Tabel Layer</h3>
    <div class="overflow-auto rounded-xl border">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="text-left p-2">Layer</th>
            <th class="text-left p-2">Modal</th>
            <th class="text-left p-2">Harga</th>
            <th class="text-left p-2">Floating Loss</th>
            <th class="text-left p-2">Equity</th>
            <th class="text-left p-2">Status</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Grafik -->
  <div class="bg-white rounded-2xl shadow p-5 fade-in">
    <h3 class="font-semibold mb-2">Grafik Equity</h3>
    <canvas id="chart" height="160"></canvas>
  </div>

<script>
/* ---------- Helpers & Params ---------- */
const q = new URLSearchParams(location.search);
const $ = id => document.getElementById(id);

function getNumParam(name, fallback){
  const v = q.get(name);
  const n = v === null ? NaN : +(`${v}`.trim().replace(',', '.'));
  return Number.isFinite(n) ? n : fallback;
}

const inputs = {
  modal: getNumParam('modal', 0),
  lot:   getNumParam('lot', 0),
  price: getNumParam('price', 0),
};
const s1Initial = getNumParam('s1', 2); // spacing Tahap 1 dari form
const CONTRACT_SIZE = 100;
let chartRef = null;

const fmt  = n => Number(n ?? 0).toLocaleString("en-US");
const fmt2 = n => (isFinite(n) ? Number(n).toFixed(2) : "0.00");
const pct  = x => `${isFinite(x) ? x.toFixed(2) : "0.00"}%`;

/* ---------- UI Events ---------- */
document.getElementById("btn-reset-spacing").addEventListener("click", ()=>{
  $("spacing-1").value = 2;
  $("spacing-2").value = 5;
  $("spacing-3").value = 10;
  renderAll();
});
document.getElementById("btn-apply-spacing").addEventListener("click", renderAll);

/* ---------- Simulation ---------- */
function simulate(maxIter = 50000, priceFloor = 0) {
  const valPerDollar = inputs.lot * CONTRACT_SIZE;
  const s1 = +$("spacing-1").value || 2;
  const s2 = +$("spacing-2").value || 5;
  const s3 = +$("spacing-3").value || 10;

  const bs = [
    { name:"Tahap 1", trigger: inputs.modal/3,     spacing: s1 },
    { name:"Tahap 2", trigger: (2*inputs.modal)/3, spacing: s2 },
    { name:"Tahap 3", trigger: Infinity,           spacing: s3 },
  ];

  let rows = [], offset = 0, floating = 0, stop = null, i = 0;

  while (i < maxIter) {
    i++;
    const b = bs.find(x => floating < x.trigger) || bs.at(-1);
    offset += b.spacing;

    const harga = inputs.price - offset;
    if (harga <= priceFloor) break;

    // Tambahan floating untuk layer baru (aproksimasi segitiga kumulatif)
    const flAdd = (inputs.price - harga) * valPerDollar;
    floating += flAdd;

    const equity = inputs.modal - floating;
    let status = "Aman";
    if (equity <= 0) status = "STOP";
    else if (b.name === "Tahap 2") status = "Waspada";
    else if (b.name === "Tahap 3") status = "Darurat";

    rows.push({ layer:i, bucket:b.name, harga, floating, equity, status });
    if (status === "STOP") { stop = rows[rows.length - 1]; break; }
  }
  return { rows, stop };
}

/* ---------- Render ---------- */
function renderAll(){
  // Header recap
  $("recap").innerHTML = `
    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 text-gray-700">
      Modal: <b>${fmt(inputs.modal)} USC</b> • Lot/layer: <b>${inputs.lot}</b> • Harga awal: <b>${fmt2(inputs.price)}</b>
    </span>`;

  const { rows, stop } = simulate();

  // Hitung jumlah status dari tabel
  const aman    = rows.filter(r=>r.status==="Aman").length;
  const waspada = rows.filter(r=>r.status==="Waspada").length;
  const darurat = rows.filter(r=>r.status==="Darurat").length;

  $("cap-1").textContent = `${aman} Layer`;
  $("cap-2").textContent = `${waspada} Layer`;
  $("cap-3").textContent = `${darurat} Layer`;

  // Detail Summary
  const last     = rows.at(-1);
  const endPrice = stop ? stop.harga : last?.harga ?? inputs.price;
  const minEq    = rows.length ? Math.min(...rows.map(r=>r.equity)) : inputs.modal;
  const maxDD    = inputs.modal ? ((inputs.modal - minEq) / inputs.modal) * 100 : 0;
  const dropAbs  = inputs.price - endPrice;
  const dropPct  = inputs.price ? (dropAbs / inputs.price) * 100 : 0;

  $("summary-detail").innerHTML = `
    <div class="grid md:grid-cols-3 gap-3">
      <div class="rounded-xl border p-4">
        <div class="text-xs text-gray-500">Total Layer Aktif</div>
        <div class="text-lg font-semibold">${stop ? stop.layer : last?.layer ?? 0}</div>
      </div>
      <div class="rounded-xl border p-4">
        <div class="text-xs text-gray-500">Harga Stop</div>
        <div class="text-lg font-semibold">${fmt2(endPrice)}</div>
      </div>
      <div class="rounded-xl border p-4">
        <div class="text-xs text-gray-500">Total Lot</div>
        <div class="text-lg font-semibold">${fmt2(((stop ? stop.layer : last?.layer ?? 0) * inputs.lot) || 0)}</div>
      </div>
      <div class="rounded-xl border p-4">
        <div class="text-xs text-gray-500">Floating Loss</div>
        <div class="text-lg font-semibold">${fmt(stop ? stop.floating : last?.floating ?? 0)}</div>
      </div>
      <div class="rounded-xl border p-4">
        <div class="text-xs text-gray-500">Equity</div>
        <div class="text-lg font-semibold">${fmt(stop ? minEq : last?.equity ?? inputs.modal)}</div>
      </div>
      <div class="rounded-xl border p-4">
        <div class="text-xs text-gray-500">Penurunan dari Harga Entry</div>
        <div class="text-lg font-semibold">-${pct(dropPct)}</div>
      </div>
    </div>`;

  // Tabel
  const tb = $("tbody"); tb.innerHTML = "";
  rows.forEach(r=>{
    let rowClass="";
    if(r.status==="STOP") rowClass="bg-red-100";
    else if(r.status==="Aman") rowClass="bg-emerald-50";
    else if(r.status==="Waspada") rowClass="bg-amber-50";
    else if(r.status==="Darurat") rowClass="bg-rose-50";
    tb.innerHTML += `
      <tr class="${rowClass}">
        <td class="p-2">${r.layer}</td>
        <td class="p-2">${r.bucket}</td>
        <td class="p-2">${fmt2(r.harga)}</td>
        <td class="p-2">${fmt(r.floating)}</td>
        <td class="p-2">${fmt(r.equity)}</td>
        <td class="p-2 font-semibold">${r.status}</td>
      </tr>`;
  });

  // Grafik
  const ctx = $("chart").getContext("2d");
  if(chartRef) chartRef.destroy();
  chartRef = new Chart(ctx,{
    type:"line",
    data:{ labels: rows.map(r=>fmt2(r.harga)), datasets:[{ label:"Equity (USC)", data: rows.map(r=>r.equity), borderColor:"#2563eb", borderWidth:2, tension:.2 }] },
    options:{ responsive:true, scales:{ x:{ title:{display:true,text:"Harga Entry"} }, y:{ title:{display:true,text:"Equity (USC)"} } } }
  });
}

/* ---------- Init: seed spacing-1 dari form, baru render ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  $("spacing-1").value = Number.isFinite(s1Initial) ? s1Initial : 2;
  if(!$("spacing-2").value) $("spacing-2").value = 5;
  if(!$("spacing-3").value) $("spacing-3").value = 10;
  renderAll();
});
</script>
</body>
</html>
