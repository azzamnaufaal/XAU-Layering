<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XAU Layering Simulator (Buckets & STOP)</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-6xl mx-auto p-4 space-y-4">
    <h1 class="text-2xl font-bold">XAU Layering Simulator (Buckets & STOP)</h1>

    <!-- Controls -->
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl shadow p-4 space-y-3">
        <h2 class="font-semibold">General</h2>
        <label class="block text-sm">Modal (USC)
          <input id="modal" type="number" class="w-full border rounded-lg p-2" value="70000"/>
        </label>
        <label class="block text-sm">Lot per Layer
          <input id="lot" type="number" step="0.01" class="w-full border rounded-lg p-2" value="0.03"/>
        </label>
        <label class="block text-sm">Contract Size (Gold=100)
          <input id="contract" type="number" class="w-full border rounded-lg p-2" value="100"/>
        </label>
        <label class="block text-sm">Harga Awal
          <input id="price" type="number" class="w-full border rounded-lg p-2" value="3700"/>
        </label>

        <div class="flex items-center gap-2">
          <input id="filterActive" type="checkbox" class="h-4 w-4">
          <label for="filterActive" class="text-sm">Tampilkan hanya baris sebelum STOP</label>
        </div>

        <div class="flex gap-2">
          <button id="runBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">Run Simulation</button>
          <button id="csvBtn" class="px-4 py-2 border rounded-lg shadow hover:bg-gray-50">Export CSV</button>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4 space-y-3 lg:col-span-2">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Buckets</h2>
          <button id="addBucket" class="px-3 py-2 border rounded-lg hover:bg-gray-50">+ Add Bucket</button>
        </div>
        <div id="buckets" class="space-y-2"></div>
        <div class="text-xs text-gray-500">
          <p>Trigger = ambang floating loss kumulatif (USC). Sistem pakai bucket pertama yang memenuhi syarat.</p>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-2">Summary</h2>
        <div id="summary" class="text-sm space-y-1">
          <div><span class="font-semibold">STOP:</span> -</div>
          <div><span class="font-semibold">Layer STOP:</span> -</div>
          <div><span class="font-semibold">Harga STOP:</span> -</div>
          <div><span class="font-semibold">Total Lot STOP:</span> -</div>
          <div><span class="font-semibold">Bucket STOP:</span> -</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
        <h2 class="font-semibold mb-2">Equity vs Harga Entry</h2>
        <canvas id="chart" height="120"></canvas>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-xl shadow p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Tabel Layer</h2>
        <div class="text-xs text-gray-500">Merah = STOP</div>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-200">
            <tr>
              <th class="text-left p-2">Layer</th>
              <th class="text-left p-2">Bucket</th>
              <th class="text-left p-2">Harga Entry</th>
              <th class="text-left p-2">Floating Loss</th>
              <th class="text-left p-2">Equity</th>
              <th class="text-left p-2">Status</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
let buckets = [
  { name: "B1", trigger: 70000/3, spacing: 2 },
  { name: "B2", trigger: (2*70000)/3, spacing: 5 },
  { name: "B3", trigger: 70000, spacing: 10 },
];

function el(tag, attrs={}, children=[]) {
  const node = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if (k==="class") node.className=v;
    else if (k.startsWith("on")) node.addEventListener(k.slice(2).toLowerCase(), v);
    else node.setAttribute(k,v);
  });
  (Array.isArray(children)?children:[children]).forEach(c=>{
    if (typeof c==="string") node.appendChild(document.createTextNode(c));
    else if (c) node.appendChild(c);
  });
  return node;
}

function renderBuckets() {
  const wrap=document.getElementById("buckets");
  wrap.innerHTML="";
  buckets.forEach((b,idx)=>{
    const row=el("div",{class:"grid grid-cols-12 gap-2 items-center"},[
      el("input",{class:"col-span-2 border rounded p-2",value:b.name,oninput:e=>{b.name=e.target.value;}}),
      el("input",{class:"col-span-5 border rounded p-2",type:"number",value:b.trigger,oninput:e=>{b.trigger=+e.target.value;}}),
      el("input",{class:"col-span-3 border rounded p-2",type:"number",value:b.spacing,oninput:e=>{b.spacing=+e.target.value;}}),
      el("button",{class:"col-span-2 px-3 py-2 border rounded-lg hover:bg-gray-50",onclick:()=>{buckets.splice(idx,1);renderBuckets();}},"Hapus")
    ]);
    wrap.appendChild(row);
  });
}

function addBucket(){ buckets.push({name:"New",trigger:10000,spacing:20}); renderBuckets(); }

function runSimulation(){
  const modal=+document.getElementById("modal").value||0;
  const lot=+document.getElementById("lot").value||0;
  const contract=+document.getElementById("contract").value||100;
  const price=+document.getElementById("price").value||0;
  const filterActive=document.getElementById("filterActive").checked;
  const valPerDollar=lot*contract;

  const bSorted=[...buckets].sort((a,b)=>a.trigger-b.trigger);
  let rows=[],offset=0,floating=0,stop=null;

  for(let i=1;i<=200;i++){
    const b=bSorted.find(x=>floating<x.trigger)||bSorted[bSorted.length-1];
    offset+=b.spacing;
    const hargaEntry=price-offset;
    const flPos=(price-hargaEntry)*valPerDollar;
    floating+=flPos;
    const equity=modal-floating;
    const status=equity<=0?"STOP":"";
    const row={layer:i,bucket:b.name,hargaEntry,floatingLoss:floating,equity,status};
    rows.push(row);
    if(status==="STOP"){ stop=row; break; }
  }
  if(filterActive&&stop) rows=rows.filter(r=>r.layer<=stop.layer);
  renderTable(rows);
  renderSummary(stop,lot);
  renderChart(rows);
  return rows;
}

function renderTable(rows){
  const tb=document.getElementById("tbody"); tb.innerHTML="";
  rows.forEach(r=>{
    const tr=el("tr",{class:r.status==="STOP"?"bg-red-100":""},[
      el("td",{class:"p-2"},r.layer),
      el("td",{class:"p-2"},r.bucket),
      el("td",{class:"p-2"},r.hargaEntry.toFixed(2)),
      el("td",{class:"p-2"},r.floatingLoss.toLocaleString()),
      el("td",{class:"p-2"},r.equity.toLocaleString()),
      el("td",{class:"p-2"},r.status),
    ]);
    tb.appendChild(tr);
  });
}

function renderSummary(stop,lot){
  const s=document.getElementById("summary");
  if(!stop){s.innerHTML="<div>Belum ada STOP</div>";return;}
  s.innerHTML=`
    <div><b>STOP:</b> Equity â‰¤ 0</div>
    <div><b>Layer STOP:</b> ${stop.layer}</div>
    <div><b>Harga STOP:</b> ${stop.hargaEntry.toFixed(2)}</div>
    <div><b>Total Lot STOP:</b> ${(stop.layer*lot).toFixed(2)} lot</div>
    <div><b>Bucket STOP:</b> ${stop.bucket}</div>`;
}

let chart;
function renderChart(rows){
  const ctx=document.getElementById("chart").getContext("2d");
  const data={labels:rows.map(r=>r.hargaEntry.toFixed(2)),datasets:[{label:"Equity",data:rows.map(r=>r.equity),borderWidth:2,fill:false,tension:0.2}]};
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:"line",data,options:{responsive:true,scales:{x:{title:{display:true,text:"Harga Entry"}},y:{title:{display:true,text:"Equity"}}}}});
}

function exportCSV(rows){
  const header=["layer","bucket","harga_entry","floating_loss","equity","status"];
  const lines=[header.join(",")];
  rows.forEach(r=>{lines.push([r.layer,r.bucket,r.hargaEntry.toFixed(2),r.floatingLoss,r.equity,r.status].join(","));});
  const blob=new Blob([lines.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="simulation.csv";a.click();
}

renderBuckets();
document.getElementById("addBucket").addEventListener("click",addBucket);
document.getElementById("runBtn").addEventListener("click",runSimulation);
document.getElementById("csvBtn").addEventListener("click",()=>{const rows=runSimulation();exportCSV(rows);});
document.getElementById("filterActive").addEventListener("change",runSimulation);
runSimulation();
</script>
</body>
</html>
